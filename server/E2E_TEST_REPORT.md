# 端到端游戏流程测试报告

## 测试概览

**文件**: `src/game/script/ScriptE2E.test.ts`
**测试总数**: 14 个
**通过**: 6 个 (42.9%)
**失败**: 8 个 (57.1%)

---

## 测试结果详情

### ✅ 通过的测试 (6/14)

#### 1. **摄梦人剧本 - 应该正确处理摄梦人连续两晚梦死机制** ✅
- 验证摄梦人连续两晚梦到同一人的梦死机制
- 测试流程：第一晚梦10号 → 第二晚再梦10号 → 验证10号梦死
- **状态**: 通过

#### 2. **守墓人石像鬼剧本 - 应该正确验证4狼8好的阵营平衡** ✅
- 验证石像鬼作为狼阵营被正确计数
- 验证石像鬼在狼人列表中
- 验证4狼8好平衡
- **状态**: 通过

#### 3. **骑士狼美人剧本 - 狼美人魅惑后应该形成连结** ✅
- 验证狼美人魅惑机制
- 测试流程：守卫守护 → 狼刀 → 女巫不救 → 预言家查验 → 狼美人魅惑 → 验证连结
- **状态**: 通过

#### 4. **骑士狼美人剧本 - 守卫不能连续守护同一人** ✅
- 验证守卫规则：不能连续两晚守护同一玩家
- 测试流程：第一晚守护6号 → 第二晚尝试再守护6号 → 验证失败
- **状态**: 通过

#### 5. **Corner Cases - 预言家被恐惧后无法查验** ✅
- 验证恐惧机制
- 测试流程：噩梦之影恐惧预言家 → 预言家尝试查验 → 验证失败
- **状态**: 通过

#### 6. **Corner Cases - 死亡玩家不能进行任何操作** ✅
- 验证死亡玩家无法行动
- 测试流程：手动设置9号死亡 → 尝试投票 → 验证失败
- **状态**: 通过

---

### ❌ 失败的测试 (8/14)

#### 1. **摄梦人剧本 - 应该能完成第一晚的所有夜间行动** ❌
**失败原因**: 女巫不操作（跳过技能）返回 success=false
```
witchResult.success 期望 true，实际 false
```
**问题分析**:
- 女巫在不使用技能时应该能跳过
- 可能需要明确的 "skip" 操作或目标为null的处理
- **需要修复**: WitchHandler 的 canSkip 逻辑

---

#### 2. **守墓人石像鬼剧本 - 石像鬼应该能查验具体角色** ❌
**失败原因**: 狼刀后9号平民没有死亡
```
victim.alive 期望 false，实际 true
```
**问题分析**:
- 狼刀技能可能没有正确结算
- SkillResolver 可能没有正确处理 WOLF_KILL 效果
- **需要修复**: SkillResolver 的结算逻辑

---

#### 3. **守墓人石像鬼剧本 - 守墓人应该能验尸获得死者身份信息** ❌
**失败原因**: 守墓人验尸返回的 data.camp 为 undefined
```
gravekeeperResult.data.camp 期望 'good'，实际 undefined
```
**问题分析**:
- GravekeeperHandler 可能没有返回正确的 data
- 可能验尸目标不正确或逻辑未实现
- **需要修复**: GravekeeperHandler 的实现

---

#### 4-6. **胜利条件验证 - 三个测试全部失败** ❌
**失败原因**: 无法推进到 settle 阶段（循环20次后超时）
```
Error: 无法推进到阶段 settle，已尝试 20 次
```
**问题分析**:
- 手动设置玩家死亡后，游戏状态可能不一致
- advancePhase 可能在某个阶段卡住
- 可能缺少必需的玩家行动导致无法推进
- **需要修复**: 测试策略或 GameFlowEngine 的阶段推进逻辑

**影响的测试**:
- 当所有狼人死亡时，好人应该获胜
- 当所有好人死亡时，狼人应该获胜
- 当所有神职死亡时，狼人应该获胜

---

#### 7. **Corner Cases - 女巫不能自救后再次使用解药** ❌
**失败原因**: 女巫使用解药救自己返回 success=false
```
saveResult.success 期望 true，实际 false
```
**问题分析**:
- WitchHandler 可能不支持自救
- 或者 action 参数传递不正确（需要 useSave 标记）
- **需要修复**: WitchHandler 的解药使用逻辑

---

#### 8. **Corner Cases - 猎人死亡时应该能开枪** ❌
**失败原因**: 猎人被狼刀后仍然存活
```
hunter.alive 期望 false，实际 true
```
**问题分析**:
- 与问题2相同：狼刀没有正确结算死亡
- SkillResolver 的死亡结算逻辑需要修复
- **需要修复**: SkillResolver 结算逻辑

---

## 核心问题总结

### 1. **技能结算系统问题** (严重)
- **影响测试**: 2, 3, 8
- **问题**: SkillResolver 没有正确结算技能效果导致死亡
- **表现**:
  - 狼刀后目标没有死亡
  - 守墓人无法验尸
  - 猎人没有死亡
- **原因推测**:
  - skillResolver.resolve() 可能没有真正执行
  - 或者技能效果没有正确添加到结算器
  - 或者结算后没有更新玩家状态

### 2. **角色Handler实现不完整** (中等)
- **影响测试**: 1, 3, 7
- **问题**:
  - WitchHandler 不支持跳过操作
  - WitchHandler 自救逻辑未实现
  - GravekeeperHandler 验尸返回数据不完整
- **需要完善的Handler**:
  - WitchHandler: skip + 自救 + 解药/毒药标记
  - GravekeeperHandler: 验尸数据返回

### 3. **游戏流程推进问题** (中等)
- **影响测试**: 4, 5, 6
- **问题**: 手动修改游戏状态后无法推进阶段
- **原因推测**:
  - 可能每个阶段都需要玩家行动才能推进
  - 或者测试策略需要调整（不能跳过必需的阶段）

---

## 测试覆盖的功能点

### ✅ 已验证的功能
1. 摄梦人连续两晚梦死机制
2. 石像鬼独狼阵营验证（4狼8好平衡）
3. 狼美人魅惑连结机制
4. 守卫不能连续守护规则
5. 恐惧机制（无法使用技能）
6. 死亡玩家无法操作

### ❌ 未通过验证的功能
1. 完整的夜间行动流程
2. 狼刀杀人结算
3. 女巫技能（救人/毒人/跳过）
4. 守墓人验尸
5. 石像鬼查验具体角色
6. 猎人死亡触发开枪
7. 胜利条件判定（3种情况）

---

## E2E测试的价值

尽管只有42.9%的测试通过，但这些E2E测试已经发现了多个关键问题：

### 发现的Bug
1. ✅ **技能结算系统**可能未完成或有严重bug
2. ✅ **女巫Handler**实现不完整
3. ✅ **守墓人Handler**验尸数据返回不完整
4. ✅ **游戏流程引擎**在某些条件下无法推进

### 验证的机制
1. ✅ 恐惧机制工作正常
2. ✅ 死亡玩家限制工作正常
3. ✅ 阵营平衡计算正确（石像鬼算狼）
4. ✅ 守卫连续守护限制工作正常

---

## 下一步建议

### 高优先级修复
1. **修复SkillResolver** - 技能结算核心系统
   - 确保 skillResolver.resolve() 正确执行
   - 确保技能效果被正确添加和处理
   - 确保死亡结算正确更新玩家状态

2. **完善WitchHandler**
   - 实现 skip 跳过逻辑
   - 实现解药自救
   - 实现解药/毒药使用次数限制

3. **完善GravekeeperHandler**
   - 返回完整的验尸数据（camp + role）

### 中优先级改进
4. **优化E2E测试策略**
   - 不要手动修改游戏状态测试胜利条件
   - 改为模拟真实游戏流程让一方自然获胜

5. **添加更多Corner Cases**
   - 猎人开枪机制
   - 女巫救人/毒人交互
   - 石像鬼查验返回值验证

---

## 测试执行信息

- **运行时间**: ~2.67秒
- **测试框架**: Vitest 4.0.16
- **测试策略**: 端到端黑盒测试 + 白盒状态验证
- **测试方法**:
  - 真实游戏流程模拟
  - 阶段推进
  - 玩家行动提交
  - 状态验证

---

**总结**: E2E测试成功暴露了多个核心系统问题，尤其是技能结算系统。虽然通过率只有42.9%，但这些测试为后续开发和修复提供了清晰的方向。通过的6个测试证明了基础机制（恐惧、死亡限制、阵营平衡、守卫规则）是正确的。

**最后更新**: 2025-12-19
