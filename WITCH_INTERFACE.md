# 女巫界面优化说明 🧪

## 📊 优化概述

本次优化重新设计了女巫的操作界面，使其更加直观、易用，并且符合狼人杀游戏规则中女巫的特殊机制。

---

## 🎯 设计目标

根据用户需求，女巫界面需要满足以下要求：

1. **分离展示**: 解药和毒药分别显示为独立的操作项
2. **互斥使用**: 同一轮只能使用一种药水（解药或毒药）
3. **自动通知**: 当女巫有解药时，自动显示昨晚被刀的玩家
4. **明确选择**:
   - 解药：两个按钮（"使用" / "不使用"）
   - 毒药：两个按钮（"使用毒药" / "不使用"），选择使用后弹出目标选择框

---

## 🎨 界面设计

### 1. 整体布局

女巫界面分为以下几个部分：

```
┌─────────────────────────────────────┐
│  🧪 女巫阶段                         │
├─────────────────────────────────────┤
│  [昨晚被刀信息]                      │
│  [技能状态显示]                      │
│  [解药操作区]                        │
│  [毒药操作区]                        │
│  [提交按钮]                          │
└─────────────────────────────────────┘
```

### 2. 被刀信息显示

当女巫有解药时，会在界面顶部显示昨晚被刀的玩家：

```
┌─────────────────────────────────┐
│ 昨晚被刀: X号                    │  (红色背景)
└─────────────────────────────────┘
```

### 3. 技能状态

实时显示女巫当前拥有的技能：

```
你的技能状态
解药 ✓ 可用    毒药 ✓ 可用
解药 ✗ 已使用  毒药 ✓ 可用
```

### 4. 解药操作区

两个按钮，左右布局：

```
💊 解药
┌──────────────┐  ┌──────────────┐
│  使用解药     │  │  不使用       │
└──────────────┘  └──────────────┘
```

**按钮状态：**
- **可用状态**: 绿色半透明背景，可点击
- **已选中**: 绿色实心背景
- **不可用**: 灰色背景，不可点击
- **互斥禁用**: 选择毒药后，解药按钮禁用

### 5. 毒药操作区

两个按钮，左右布局：

```
☠️ 毒药
┌──────────────┐  ┌──────────────┐
│  使用毒药     │  │  不使用       │
└──────────────┘  └──────────────┘
```

**按钮状态：**
- **可用状态**: 红色半透明背景，可点击
- **已选中**: 红色实心背景
- **不可用**: 灰色背景，不可点击
- **互斥禁用**: 选择解药后，毒药按钮禁用

### 6. 毒药目标选择弹窗

点击"使用毒药"后弹出模态框：

```
┌──────────────────────────────┐
│  选择毒药目标                 │
│                              │
│  选择要毒死的玩家             │
│  ┌──────────────────────┐    │
│  │ [下拉选择框]          │    │
│  │ - 1号 - test1        │    │
│  │ - 2号 - test2        │    │
│  └──────────────────────┘    │
│                              │
│  ┌──────┐    ┌──────┐        │
│  │ 确认 │    │ 取消 │        │
│  └──────┘    └──────┘        │
└──────────────────────────────┘
```

---

## 🔧 技术实现

### 修改文件

**`client/src/pages/PlayerView.tsx`** - 玩家视图组件

### 新增状态

```typescript
// 女巫专用状态
const [witchAction, setWitchAction] = useState<'none' | 'antidote' | 'poison'>('none');
const [showPoisonModal, setShowPoisonModal] = useState(false);
const [poisonTarget, setPoisonTarget] = useState<number>(0);
```

**状态说明：**
- `witchAction`: 当前选择的操作（无/解药/毒药）
- `showPoisonModal`: 是否显示毒药目标选择弹窗
- `poisonTarget`: 毒药目标的玩家号位

### 核心逻辑

#### 1. 女巫提交操作

```typescript
const handleWitchSubmit = () => {
  if (!myPlayer || !currentGame) return;

  let actionType = 'none';
  let target = 0;

  if (witchAction === 'antidote') {
    actionType = 'save';
    target = currentGame.nightActions.witchKnowsVictim || 0;
  } else if (witchAction === 'poison') {
    actionType = 'poison';
    target = poisonTarget;
  }

  const action = {
    phase: currentGame.currentPhase,
    playerId: myPlayer.playerId,
    actionType,
    target,
  };

  wsService.send({ type: 'PLAYER_SUBMIT_ACTION', action });

  // 重置状态
  setWitchAction('none');
  setPoisonTarget(0);
  setShowPoisonModal(false);
};
```

#### 2. 解药操作

```typescript
const handleUseAntidote = () => {
  setWitchAction('antidote');
};

const handleNoAntidote = () => {
  setWitchAction('none');
};
```

#### 3. 毒药操作

```typescript
const handleUsePoisonClick = () => {
  setWitchAction('poison');
  setShowPoisonModal(true);
};

const handleNoPoison = () => {
  setWitchAction('none');
};

const handleConfirmPoison = () => {
  if (poisonTarget === 0) {
    alert('请选择毒药目标');
    return;
  }
  setShowPoisonModal(false);
};
```

### 互斥逻辑实现

使用按钮的 `disabled` 属性实现互斥：

```typescript
// 解药按钮
disabled={!myPlayer.abilities.antidote || witchAction === 'poison'}

// 毒药按钮
disabled={!myPlayer.abilities.poison || witchAction === 'antidote'}
```

**禁用条件：**
1. 技能已用完（`!abilities.antidote` 或 `!abilities.poison`）
2. 已选择另一种药水（互斥）

---

## 📋 使用流程

### 场景1：使用解药

1. 女巫进入witch阶段
2. 界面自动显示"昨晚被刀: X号"
3. 女巫查看技能状态（解药可用）
4. 点击"使用解药"按钮（按钮变为绿色实心）
5. 此时毒药按钮自动禁用（灰色）
6. 点击"提交操作"
7. 系统提示"操作成功"

### 场景2：使用毒药

1. 女巫进入witch阶段
2. 女巫查看技能状态（毒药可用）
3. 点击"使用毒药"按钮
4. 弹出目标选择框
5. 在下拉列表中选择要毒死的玩家
6. 点击"确认"（弹窗关闭，毒药按钮变为红色实心）
7. 此时解药按钮自动禁用（灰色）
8. 点击"提交操作"
9. 系统提示"操作成功"

### 场景3：不使用药水

1. 女巫进入witch阶段
2. 直接点击解药或毒药区域的"不使用"按钮
3. 点击"提交操作"
4. 系统提示"操作成功"

### 场景4：取消毒药选择

1. 点击"使用毒药"
2. 弹出目标选择框
3. 点击"取消"
4. 弹窗关闭，回到初始状态（可重新选择）

---

## 🎮 按钮状态矩阵

| 女巫状态 | 解药按钮（使用） | 解药按钮（不使用） | 毒药按钮（使用） | 毒药按钮（不使用） |
|---------|----------------|-------------------|----------------|-------------------|
| 初始状态（解药可用） | 🟢 可点击 | 🔘 已选中 | 🟠 可点击 | 🔘 已选中 |
| 初始状态（解药已用） | ⚫ 禁用 | 🔘 已选中 | 🟠 可点击 | 🔘 已选中 |
| 选择解药 | 🟢 已选中 | 🟢 可点击 | ⚫ 禁用 | ⚫ 禁用 |
| 选择毒药 | ⚫ 禁用 | ⚫ 禁用 | 🔴 已选中 | 🔴 可点击 |
| 初始状态（毒药已用） | 🟢 可点击 | 🔘 已选中 | ⚫ 禁用 | 🔘 已选中 |

**颜色说明：**
- 🟢 绿色 = 解药相关
- 🔴 红色 = 毒药相关
- 🟠 橙红色 = 毒药可用
- ⚫ 灰色 = 禁用
- 🔘 灰色 = 默认选中（不使用）

---

## 🎨 视觉设计

### 颜色方案

```css
/* 解药区域 */
- 可用: bg-green-600/30 hover:bg-green-600/50
- 选中: bg-green-600
- 禁用: bg-gray-600/30

/* 毒药区域 */
- 可用: bg-red-600/30 hover:bg-red-600/50
- 选中: bg-red-600
- 禁用: bg-gray-600/30

/* 被刀信息 */
- 背景: bg-red-600/20 border-red-500

/* 技能状态 */
- 可用: text-green-400 / text-red-400
- 已用: text-gray-500
```

### 布局细节

```css
/* 按钮间距 */
gap-4  /* 按钮之间16px间距 */

/* 模块间距 */
mb-6   /* 每个模块底部24px间距 */

/* 按钮大小 */
py-3   /* 垂直内边距12px */
```

---

## 🔄 状态流转图

```
初始状态 (witchAction: 'none')
    │
    ├─→ 点击"使用解药" ─→ witchAction: 'antidote'
    │                         │
    │                         └─→ 提交 ─→ 重置为 'none'
    │
    ├─→ 点击"使用毒药" ─→ witchAction: 'poison'
    │                         │
    │                         ├─→ 打开弹窗 ─→ 选择目标
    │                         │              │
    │                         │              ├─→ 确认 ─→ 关闭弹窗
    │                         │              │          │
    │                         │              │          └─→ 提交 ─→ 重置
    │                         │              │
    │                         │              └─→ 取消 ─→ 重置为 'none'
    │                         │
    │
    └─→ 点击"不使用" ─→ 保持 'none' ─→ 提交 ─→ 重置
```

---

## ✅ 功能清单

- ✅ 解药和毒药分离展示
- ✅ 同一轮互斥使用（选择一个禁用另一个）
- ✅ 自动显示被刀玩家信息
- ✅ 实时显示技能状态（可用/已使用）
- ✅ 解药两个按钮（使用/不使用）
- ✅ 毒药两个按钮（使用/不使用）
- ✅ 毒药目标选择弹窗
- ✅ 取消操作支持
- ✅ 状态重置（提交后自动重置）
- ✅ 按钮禁用逻辑（技能用完、互斥、已选中）
- ✅ 视觉反馈（颜色变化、禁用状态）
- ✅ 操作确认（毒药必须选择目标）

---

## 🆚 优化对比

| 功能 | 优化前 | 优化后 |
|-----|--------|--------|
| 操作方式 | 单一下拉框选择目标 | 分离的解药/毒药按钮 |
| 被刀信息 | 弹窗提示（一次性） | 界面持续显示 |
| 技能状态 | 不显示 | 实时显示可用/已用 |
| 互斥控制 | 无明确限制 | 按钮自动禁用 |
| 毒药目标 | 同一个下拉框 | 独立的模态弹窗 |
| 视觉反馈 | 简单文本 | 彩色按钮+图标+状态 |
| 操作明确性 | 不清晰 | 非常清晰 |
| 用户体验 | 一般 | 优秀 |

---

## 🐛 注意事项

1. **解药自动救人**: 使用解药时不需要选择目标，自动救治被刀的玩家
2. **毒药必须选目标**: 使用毒药必须在弹窗中选择一个活着的玩家
3. **互斥检查**: 前端和后端都应该验证同一轮不能同时使用两种药水
4. **状态重置**: 每次提交后必须重置 witchAction、poisonTarget、showPoisonModal
5. **技能消耗**: 使用后对应的 ability 字段应该被标记为 false

---

## 📚 相关文档

- [QUICK_START.md](./QUICK_START.md) - 快速开始指南
- [USER_GUIDE.md](./USER_GUIDE.md) - 完整使用指南
- [OPTIMIZATION.md](./OPTIMIZATION.md) - 上次优化说明
- [HOT_RELOAD.md](./HOT_RELOAD.md) - 热重载开发指南

---

## 🎉 总结

本次女巫界面优化实现了：
- ✅ 符合游戏规则的操作流程
- ✅ 清晰直观的视觉设计
- ✅ 完善的互斥和状态管理
- ✅ 良好的用户体验和反馈

**现在女巫玩家可以轻松、明确地完成自己的夜间操作！** 🧪✨
