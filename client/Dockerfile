# ğŸº ç‹¼äººæ€å‰ç«¯åº”ç”¨ - Dockeré•œåƒ
# é€‚ç”¨äºï¼šé˜¿é‡Œäº‘å‡½æ•°è®¡ç®—ã€ç‹¬ç«‹éƒ¨ç½²

# ========================================
# é˜¶æ®µ1: æ„å»º
# ========================================
FROM node:18-alpine AS builder

WORKDIR /app

# å¤åˆ¶package.json
COPY package*.json ./
COPY ../shared/package*.json ../shared/

# å®‰è£…ä¾èµ–
RUN npm ci && npm cache clean --force

# å¤åˆ¶æºä»£ç å’Œé…ç½®
COPY tsconfig.json ./
COPY vite.config.ts ./
COPY index.html ./
COPY tailwind.config.js ./
COPY postcss.config.js ./
COPY src ./src
COPY ../shared ../shared

# æ„å»ºï¼ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰
ARG VITE_API_URL
ENV VITE_API_URL=$VITE_API_URL
RUN npm run build

# ========================================
# é˜¶æ®µ2: ç”Ÿäº§ç¯å¢ƒï¼ˆNginxï¼‰
# ========================================
FROM nginx:alpine

LABEL maintainer="werewolf-game"
LABEL description="ç‹¼äººæ€å‰ç«¯åº”ç”¨"
LABEL service="frontend"

# å¤åˆ¶æ„å»ºäº§ç‰©åˆ°nginxç›®å½•
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶è‡ªå®šä¹‰nginxé…ç½®
COPY nginx.conf /etc/nginx/conf.d/default.conf

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost/ || exit 1

# æš´éœ²ç«¯å£
EXPOSE 80

# å¯åŠ¨nginx
CMD ["nginx", "-g", "daemon off;"]
